<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard de Monitoramento Florestal</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.11.4/gsap.min.js"></script>
    <style>
      :root {
        --primary-color: #2c9a56;
        --secondary-color: #8c4d27;
        --light-color: #e8f5e9;
        --dark-color: #1b5e20;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        margin: 0;
        padding: 0;
        background-color: #f9f9f9;
        color: #333;
      }

      header {
        background-color: var(--primary-color);
        color: white;
        padding: 1rem 0;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .header-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 1rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .header-container h1 {
        margin: 0;
        font-size: 1.5rem;
      }

      h1 {
        margin: 0;
        font-size: 1.8rem;
      }

      /* Container do formulário de login no header */
      #loginFormContainer {
        top: 1rem;
        right: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        background-color: rgba(255, 255, 255, 0.95);
        padding: 0.5rem 1rem;
        border-radius: 8px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
      }

      /* Inputs do formulário */
      #loginForm input[type="text"],
      #loginForm input[type="password"] {
        padding: 0.4rem 0.6rem;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 0.9rem;
        width: 120px;
        transition: border 0.2s;
      }

      #loginForm input:focus {
        border-color: var(--primary-color);
        outline: none;
      }

      /* Botão de login */
      #loginForm button {
        background-color: var(--primary-color);
        color: white;
        border: none;
        padding: 0.45rem 0.8rem;
        border-radius: 4px;
        font-weight: 500;
        cursor: pointer;
        transition: background-color 0.2s;
      }

      #loginForm button:hover {
        background-color: #1b7940;
      }

      /* Área de logout */
      #logoutSection {
        position: absolute;
        top: 1rem;
        right: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        background-color: rgba(255, 255, 255, 0.95);
        padding: 0.5rem 1rem;
        border-radius: 8px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
      }

      #logoutBtn {
        background-color: #e53935;
        color: white;
        padding: 0.4rem 0.7rem;
        border: none;
        border-radius: 4px;
        font-weight: 500;
        cursor: pointer;
      }

      #logoutBtn:hover {
        background-color: #c62828;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 1rem;
      }

      .dashboard {
        display: flex;
        flex-direction: column;
        gap: 2rem;
      }

      .isometric-container {
        background-color: #d0e6f6;
        padding: 1.5rem;
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        text-align: center;
      }

      .isometric-scene {
        position: relative;
        height: 600px;
        overflow: hidden;
        border-radius: 8px;
        margin-bottom: 1rem;
        background-color: #d0e6f6; /* Fundo claro para o céu */
        perspective: 1000px;
      }

      .floating-island {
        position: absolute;
        top: 50%;
        left: 50%;
        width: 100%;
        height: 100%;
        transform: translate(-50%, -50%);
        background: url("./images/scene.png") no-repeat center center;
        background-size: cover;
        z-index: 10; /* Manter menor que o z-index das nuvens */
      }

      .isometric-grid {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 10;
      }

      .tree,
      .stump {
        position: absolute;
        transform-style: preserve-3d;
        transform: translateZ(0);
        transition: all 0.5s;
      }

      .tree {
        position: absolute;
        width: 40px;
        height: 80px;
        background: url("./images/tree.svg") no-repeat center center / contain;
        transition: all 0.5s;
        transform-origin: bottom center;
        filter: drop-shadow(2px 4px 2px rgba(0, 0, 0, 0.2));
      }

      .stump {
        position: absolute;
        width: 30px;
        height: 30px;
        background: url("./images/stump.svg") no-repeat center center / contain;
        transition: all 0.5s;
        transform-origin: bottom center;
      }

      .floating-clouds {
        position: absolute;
        width: 100%;
        height: 100%;
        top: 0;
        left: 0;
        pointer-events: none;
        z-index: 20; /* Valor maior que o da ilha flutuante */
      }

      .cloud {
        position: absolute;
        background: white;
        border-radius: 50%;
        opacity: 0.8;
        filter: blur(5px);
      }

      .chart-container {
        background-color: white;
        padding: 1.5rem;
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }

      .chart-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
      }

      .time-selectors {
        display: flex;
        gap: 0.5rem;
      }

      .time-btn {
        padding: 0.5rem 1rem;
        background-color: #e0e0e0;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.2s;
      }

      .time-btn.active {
        background-color: var(--primary-color);
        color: white;
      }

      .time-btn:hover {
        background-color: #c8e6c9;
      }

      .data-entry {
        background-color: white;
        padding: 1.5rem;
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }

      .form-group {
        margin-bottom: 1rem;
      }

      label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
      }

      input[type="number"],
      input[type="date"],
      select {
        width: 100%;
        padding: 0.5rem;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 1rem;
      }

      .btn {
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.2s;
      }

      .btn-primary {
        background-color: var(--primary-color);
        color: white;
      }

      .btn-primary:hover {
        background-color: #1b7940;
      }

      .stats-container {
        display: flex;
        justify-content: space-around;
        margin-bottom: 1rem;
      }

      .stat-card {
        flex: 1;
        max-width: 200px;
        background-color: white;
        padding: 1rem;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        text-align: center;
        margin: 0 0.5rem;
      }

      .stat-card.planted {
        border-top: 4px solid var(--primary-color);
      }

      .stat-card.cut {
        border-top: 4px solid var(--secondary-color);
      }

      .stat-card.balance {
        border-top: 4px solid #2196f3;
      }

      .stat-card.co2 {
        border-top: 4px solid #009688;
      }

      .stat-value {
        font-size: 1.8rem;
        font-weight: bold;
        margin: 0.5rem 0;
      }

      .stat-label {
        font-size: 0.9rem;
        color: #666;
      }

      .co2-indicator {
        margin-top: 1rem;
        padding: 1rem;
        border-radius: 8px;
        background-color: #e8f5e9;
        text-align: center;
      }

      .co2-meter {
        height: 30px;
        width: 100%;
        background-color: #ddd;
        border-radius: 15px;
        margin: 0.5rem 0;
        position: relative;
        overflow: hidden;
      }

      .co2-meter-fill {
        height: 100%;
        background: linear-gradient(to right, #f44336, #ffeb3b, #4caf50);
        border-radius: 15px;
        transition: width 1s ease-in-out;
        position: relative;
      }

      .co2-meter-marker {
        position: absolute;
        top: 0;
        height: 100%;
        width: 3px;
        background-color: #000;
        z-index: 2;
      }

      @media (max-width: 768px) {
        .stats-container {
          flex-direction: column;
          align-items: center;
        }

        .stat-card {
          width: 100%;
          max-width: 100%;
          margin-bottom: 1rem;
        }

        .chart-controls {
          flex-direction: column;
          gap: 1rem;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <div class="header-container">
        <h1>Dashboard de Monitoramento Florestal</h1>
        <div id="loginFormContainer">
          <form id="loginForm">
            <input
              type="text"
              name="username"
              id="username"
              placeholder="Usuário"
              required
            />
            <input
              type="password"
              name="senha"
              id="password"
              placeholder="Senha"
              required
            />
            <button type="submit" class="btn btn-primary">Login</button>
          </form>
        </div>
        <div
          id="logoutSection"
          style="display: none; position: absolute; top: 1rem; right: 1rem"
        >
          <span id="welcomeUser"></span>
          <button id="logoutBtn" class="btn">Sair</button>
        </div>
      </div>
    </header>

    <div class="container">
      <div
        id="senhaResetContainer"
        style="
          display: none;
          position: absolute;
          top: 20%;
          left: 40%;
          background: white;
          padding: 20px;
          border: 1px solid #ccc;
        "
      >
        <h3>Redefinir senha</h3>
        <input
          type="password"
          id="novaSenha"
          placeholder="Nova senha"
        /><br /><br />
        <button onclick="enviarNovaSenha()">Salvar</button>
      </div>

      <div class="dashboard">
        <div class="isometric-container">
          <div class="isometric-scene">
            <div class="floating-clouds" id="clouds"></div>
            <div class="floating-island">
              <div class="ground"></div>
              <div class="isometric-grid" id="forestGrid"></div>
            </div>
          </div>
        </div>

        <div class="stats-container">
          <div class="stat-card planted">
            <div class="stat-label">Árvores Plantadas</div>
            <div class="stat-value" id="plantedValue">0</div>
            <div class="stat-label">no período selecionado</div>
          </div>
          <div class="stat-card cut">
            <div class="stat-label">Árvores Suprimidas</div>
            <div class="stat-value" id="cutValue">0</div>
            <div class="stat-label">no período selecionado</div>
          </div>
          <div class="stat-card balance">
            <div class="stat-label">Balanço</div>
            <div class="stat-value" id="balanceValue">0</div>
            <div class="stat-label">no período selecionado</div>
          </div>
          <div class="stat-card co2">
            <div class="stat-label">Pegada de CO₂</div>
            <div class="stat-value" id="co2Value">0</div>
            <div class="stat-label">toneladas no período</div>
          </div>
        </div>

        <div class="co2-indicator">
          <h3>Impacto Ambiental - Pegada de Carbono</h3>
          <div class="co2-meter">
            <div
              class="co2-meter-fill"
              id="co2MeterFill"
              style="width: 50%"
            ></div>
            <div
              class="co2-meter-marker"
              id="co2Neutral"
              style="left: 50%"
            ></div>
          </div>
          <div id="co2Status">Impacto neutro de carbono</div>
        </div>

        <div class="chart-container">
          <div class="chart-controls">
            <h2>Estatísticas de Plantio e Supressão</h2>
            <div class="time-selectors">
              <button class="time-btn active" data-period="day">Diário</button>
              <button class="time-btn" data-period="week">Semanal</button>
              <button class="time-btn" data-period="month">Mensal</button>
              <button class="time-btn" data-period="year">Anual</button>
            </div>
          </div>
          <canvas id="forestChart"></canvas>
        </div>

        <div class="data-entry" style="display: none">
          <h2>Cadastro de Dados</h2>
          <form id="forestDataForm">
            <div class="form-group">
              <label for="date">Data:</label>
              <input type="date" id="date" required />
            </div>
            <div class="form-group">
              <label for="action">Ação:</label>
              <select id="action" required>
                <option value="planted">Árvores Plantadas</option>
                <option value="cut">Árvores Suprimidas</option>
              </select>
            </div>
            <div id="co2InfoContainer" class="form-group">
              <p id="co2EstimateInfo" class="co2-info">
                Impacto estimado: <span id="co2Estimate">0</span> kg de CO₂
              </p>
            </div>
            <div class="form-group">
              <label for="quantity">Quantidade:</label>
              <input type="number" id="quantity" min="1" required />
            </div>
            <button type="submit" class="btn btn-primary">Cadastrar</button>
          </form>
        </div>
      </div>
    </div>

    <script>
      // Dados de árvores plantadas e suprimidas
      let forestData = [];

      async function carregarDados() {
        const response = await fetch("get_dados.php");
        const dadosBrutos = await response.json();

        // Combina registros do mesmo dia
        const mapa = {};
        dadosBrutos.forEach((item) => {
          if (!mapa[item.date]) {
            mapa[item.date] = { date: item.date, planted: 0, cut: 0 };
          }
          mapa[item.date].planted += item.planted;
          mapa[item.date].cut += item.cut;
        });

        forestData = Object.values(mapa).sort(
          (a, b) => new Date(a.date) - new Date(b.date)
        );
        updateChart();
        updateStats();
        updateForestScene();
      }

      // Variáveis globais
      let currentPeriod = "day";
      let chart = null;

      // Constantes para cálculo de CO2
      const CO2_PER_TREE_PER_YEAR = 21.8; // kg de CO2 absorvido por árvore por ano
      const CO2_LOSS_PER_CUT_TREE = 150; // kg de CO2 liberado por árvore cortada

      // Inicializar a página quando o DOM estiver carregado
      document.addEventListener("DOMContentLoaded", function () {
        createClouds();
        updateForestScene();
        initializeChart();
        updateStats();

        // Event listeners
        document.querySelectorAll(".time-btn").forEach((btn) => {
          btn.addEventListener("click", function () {
            document
              .querySelectorAll(".time-btn")
              .forEach((b) => b.classList.remove("active"));
            this.classList.add("active");
            currentPeriod = this.dataset.period;
            updateChart();
            updateStats();
          });
        });

        // Atualizar informações de CO2 conforme o usuário seleciona ação e quantidade
        const actionSelect = document.getElementById("action");
        const quantityInput = document.getElementById("quantity");
        const co2EstimateInfo = document.getElementById("co2Estimate");

        function updateCO2Estimate() {
          const action = actionSelect.value;
          const quantity = parseInt(quantityInput.value) || 0;
          let co2Impact = 0;

          if (action === "planted") {
            co2Impact = (quantity * CO2_PER_TREE_PER_YEAR).toFixed(1);
            co2EstimateInfo.textContent = `+${co2Impact} kg de CO₂ absorvidos por ano`;
            co2EstimateInfo.style.color = "#2e7d32";
          } else {
            co2Impact = (quantity * CO2_LOSS_PER_CUT_TREE).toFixed(1);
            co2EstimateInfo.textContent = `-${co2Impact} kg de CO₂ liberados`;
            co2EstimateInfo.style.color = "#c62828";
          }
        }

        actionSelect.addEventListener("change", updateCO2Estimate);
        quantityInput.addEventListener("input", updateCO2Estimate);

        document
          .getElementById("forestDataForm")
          .addEventListener("submit", function (e) {
            e.preventDefault();
            const date = document.getElementById("date").value;
            const action = document.getElementById("action").value;
            const quantity = parseInt(
              document.getElementById("quantity").value
            );

            // Verificar se já existe um registro para esta data
            const existingIndex = forestData.findIndex(
              (item) => item.date === date
            );

            if (existingIndex !== -1) {
              // Atualizar registro existente
              if (action === "planted") {
                forestData[existingIndex].planted += quantity;
              } else {
                forestData[existingIndex].cut += quantity;
              }
            } else {
              // Criar novo registro
              const newData = { date: date, planted: 0, cut: 0 };
              if (action === "planted") {
                newData.planted = quantity;
              } else {
                newData.cut = quantity;
              }
              forestData.push(newData);
              // Ordenar os dados por data
              forestData.sort((a, b) => new Date(a.date) - new Date(b.date));
            }

            // Atualizar a visualização
            updateChart();
            updateForestScene();
            updateStats();

            // Resetar o formulário
            this.reset();
            alert("Dados cadastrados com sucesso!");
          });

        // Animação da ilha flutuante
        animateFloatingIsland();
      });

      // Função para criar nuvens animadas
      function createClouds() {
        const grid = document.getElementById("forestGrid");

        const cloudContainer = document.getElementById("clouds");
        const numberOfClouds = 10;

        for (let i = 0; i < numberOfClouds; i++) {
          const cloud = document.createElement("div");
          cloud.className = "cloud";

          // Tamanho aleatório
          const size = Math.random() * 100 + 50;
          cloud.style.width = `${size}px`;
          cloud.style.height = `${size / 2}px`;

          // Posição inicial aleatória
          const posX = Math.random() * 100;
          const posY = Math.random() * 60 + 10;
          cloud.style.left = `${posX}%`;
          cloud.style.top = `${posY}%`;

          cloudContainer.appendChild(cloud);

          // Animação com GSAP
          gsap.to(cloud, {
            x: `+=${grid.offsetWidth + 150}`, // move para a direita além da largura do grid
            duration: Math.random() * 60 + 60, // entre 60s e 120s (mais lento)
            repeat: -1,
            ease: "none",
            modifiers: {
              x: gsap.utils.unitize((x) => {
                // Quando sair da tela, volta para -200px
                return (parseFloat(x) % (grid.offsetWidth + 400)) - 200;
              }),
            },
          });

          gsap.to(cloud, {
            y: "+=20",
            duration: Math.random() * 10 + 5,
            repeat: -1,
            yoyo: true,
            ease: "sine.inOut",
          });
        }
      }

      // Função para animar a ilha flutuante
      function animateFloatingIsland() {
        const island = document.querySelector(".floating-island");
        gsap.to(island, {
          y: "+=20",
          duration: 4,
          repeat: -1,
          ease: "sine.inOut",
          yoyo: true,
        });

        gsap.to(island, {
          rotation: 2,
          duration: 6,
          repeat: -1,
          ease: "sine.inOut",
          yoyo: true,
        });
      }

      // Função para atualizar a cena da floresta
      // Função para atualizar a cena da floresta
      function updateForestScene() {
        const grid = document.getElementById("forestGrid");
        grid.innerHTML = ""; // Limpa a cena

        const gridWidth = grid.offsetWidth;
        const gridHeight = grid.offsetHeight;
        const cx = gridWidth / 2;
        const cy = gridHeight / 2;

        const totalTrees = 60;
        const totalPlanted = forestData.reduce((sum, d) => sum + d.planted, 0);
        const totalCut = forestData.reduce((sum, d) => sum + d.cut, 0);
        const cutPercentage = totalCut / (totalPlanted > 0 ? totalPlanted : 1);
        const treesCount = Math.round(totalTrees * (1 - cutPercentage));
        const stumpsCount = totalTrees - treesCount;

        // Verifica se um ponto está dentro do losango
        function isInsideDiamond(x, y) {
          return (
            Math.abs(x - cx) / (gridWidth / 2) +
              Math.abs(y - cy) / (gridHeight / 2) <=
            1
          );
        }

        const positions = [];

        // Gerar posições dentro do losango
        for (let i = 0; i < totalTrees; i++) {
          let attempts = 0;
          let point;
          do {
            // Gera um ponto no centro e aplica deslocamentos aleatórios
            const dx = ((Math.random() * 2 - 1) * gridWidth) / 2;
            const dy = ((Math.random() * 2 - 1) * gridHeight) / 2;

            const x = cx + dx;
            const y = cy + dy;

            point = { x, y };
            attempts++;
          } while (
            (!isInsideDiamond(point.x, point.y) || // Verifica se está dentro do losango
              positions.some(
                (p) =>
                  Math.abs(p.x - point.x) < 40 && Math.abs(p.y - point.y) < 80
              )) && // Verifica se não colide com outra árvore
            attempts < 100
          );
          positions.push(point);
        }

        // Adiciona árvores
        for (let i = 0; i < treesCount; i++) {
          const tree = document.createElement("div");
          tree.className = "tree";
          tree.style.position = "absolute";
          tree.style.left = `${positions[i].x - 20}px`; // Centraliza a árvore (largura 40)
          tree.style.top = `${positions[i].y - 40}px`; // Centraliza a árvore (altura 80)
          const scale = 0.8 + Math.random() * 0.4;
          tree.style.transform = `scale(${scale})`;
          grid.appendChild(tree);
        }

        // Adiciona troncos
        for (let i = treesCount; i < totalTrees; i++) {
          const stump = document.createElement("div");
          stump.className = "stump";
          stump.style.position = "absolute";
          stump.style.left = `${positions[i].x - 15}px`; // Centraliza o tronco (largura 30)
          stump.style.top = `${positions[i].y - 15}px`; // Centraliza o tronco (altura 30)
          grid.appendChild(stump);
        }

        // Adiciona árvores
        for (let i = 0; i < treesCount; i++) {
          const tree = document.createElement("div");
          tree.className = "tree";
          tree.style.position = "absolute";
          tree.style.left = `${positions[i].x}px`;
          tree.style.top = `${positions[i].y}px`;
          const scale = 0.8 + Math.random() * 0.4;
          tree.style.transform = `scale(${scale})`;
          grid.appendChild(tree);
        }

        // Adiciona troncos
        for (let i = treesCount; i < totalTrees; i++) {
          const stump = document.createElement("div");
          stump.className = "stump";
          stump.style.position = "absolute";
          stump.style.left = `${positions[i].x}px`;
          stump.style.top = `${positions[i].y}px`;
          grid.appendChild(stump);
        }
      }

      // Função para inicializar o gráfico
      function initializeChart() {
        const ctx = document.getElementById("forestChart").getContext("2d");
        chart = new Chart(ctx, {
          type: "bar",
          data: {
            labels: [],
            datasets: [
              {
                label: "Árvores Plantadas",
                backgroundColor: "#4caf50",
                data: [],
              },
              {
                label: "Árvores Suprimidas",
                backgroundColor: "#ff9800",
                data: [],
              },
              {
                label: "Pegada de CO₂ (ton)",
                type: "line",
                borderColor: "#009688",
                backgroundColor: "rgba(0, 150, 136, 0.2)",
                fill: true,
                data: [],
                yAxisID: "co2",
              },
            ],
          },
          options: {
            responsive: true,
            scales: {
              x: {
                stacked: false,
                title: {
                  display: true,
                  text: "Data",
                },
              },
              y: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: "Quantidade",
                },
              },
              co2: {
                position: "right",
                beginAtZero: false,
                title: {
                  display: true,
                  text: "CO₂ (toneladas)",
                },
                grid: {
                  drawOnChartArea: false,
                },
              },
            },
          },
        });

        updateChart();
      }

      // Função para atualizar o gráfico com base no período selecionado
      function updateChart() {
        const labels = [];
        const plantedData = [];
        const cutData = [];
        const co2Data = [];

        let processedData;

        switch (currentPeriod) {
          case "day":
            // Dados diários (últimos 30 dias)
            processedData = [...forestData].slice(-30);

            processedData.forEach((item) => {
              labels.push(formatDate(item.date));
              plantedData.push(item.planted);
              cutData.push(item.cut);

              // Calcular o impacto de CO2 (em toneladas)
              const co2Absorbed =
                (item.planted * CO2_PER_TREE_PER_YEAR) / 365 / 1000; // conversão para toneladas
              const co2Released = (item.cut * CO2_LOSS_PER_CUT_TREE) / 1000; // conversão para toneladas
              const co2Impact = co2Absorbed - co2Released;
              co2Data.push(co2Impact);
            });
            break;

          case "week":
            // Agrupar por semana
            processedData = groupDataByWeek(forestData);

            processedData.forEach((item) => {
              labels.push(`Semana ${item.week}`);
              plantedData.push(item.planted);
              cutData.push(item.cut);

              // Calcular o impacto de CO2 (em toneladas)
              const co2Absorbed =
                (item.planted * CO2_PER_TREE_PER_YEAR) / 52 / 1000; // conversão para toneladas
              const co2Released = (item.cut * CO2_LOSS_PER_CUT_TREE) / 1000; // conversão para toneladas
              const co2Impact = co2Absorbed - co2Released;
              co2Data.push(co2Impact);
            });
            break;

          case "month":
            // Agrupar por mês
            processedData = groupDataByMonth(forestData);

            processedData.forEach((item) => {
              labels.push(item.month);
              plantedData.push(item.planted);
              cutData.push(item.cut);

              // Calcular o impacto de CO2 (em toneladas)
              const co2Absorbed =
                (item.planted * CO2_PER_TREE_PER_YEAR) / 12 / 1000; // conversão para toneladas
              const co2Released = (item.cut * CO2_LOSS_PER_CUT_TREE) / 1000; // conversão para toneladas
              const co2Impact = co2Absorbed - co2Released;
              co2Data.push(co2Impact);
            });
            break;

          case "year":
            // Agrupar por ano
            processedData = groupDataByYear(forestData);

            processedData.forEach((item) => {
              labels.push(item.year.toString());
              plantedData.push(item.planted);
              cutData.push(item.cut);

              // Calcular o impacto de CO2 (em toneladas)
              const co2Absorbed = (item.planted * CO2_PER_TREE_PER_YEAR) / 1000; // conversão para toneladas
              const co2Released = (item.cut * CO2_LOSS_PER_CUT_TREE) / 1000; // conversão para toneladas
              const co2Impact = co2Absorbed - co2Released;
              co2Data.push(co2Impact);
            });
            break;
        }

        chart.data.labels = labels;
        chart.data.datasets[0].data = plantedData;
        chart.data.datasets[1].data = cutData;
        chart.data.datasets[2].data = co2Data;
        chart.update();
      }

      // Função para agrupar dados por semana
      function groupDataByWeek(data) {
        const weeks = {};

        data.forEach((item) => {
          const date = new Date(item.date);
          const weekOfYear = getWeekNumber(date);
          const key = `${date.getFullYear()}-${weekOfYear}`;

          if (!weeks[key]) {
            weeks[key] = {
              week: weekOfYear,
              year: date.getFullYear(),
              planted: 0,
              cut: 0,
            };
          }

          weeks[key].planted += item.planted;
          weeks[key].cut += item.cut;
        });

        return Object.values(weeks).sort((a, b) => {
          if (a.year !== b.year) return a.year - b.year;
          return a.week - b.week;
        });
      }

      // Função para obter o número da semana de uma data
      function getWeekNumber(date) {
        const firstDayOfYear = new Date(date.getFullYear(), 0, 1);
        const pastDaysOfYear = (date - firstDayOfYear) / 86400000;
        return Math.ceil((pastDaysOfYear + firstDayOfYear.getDay() + 1) / 7);
      }

      // Função para agrupar dados por mês
      function groupDataByMonth(data) {
        const months = {};
        const monthNames = [
          "Janeiro",
          "Fevereiro",
          "Março",
          "Abril",
          "Maio",
          "Junho",
          "Julho",
          "Agosto",
          "Setembro",
          "Outubro",
          "Novembro",
          "Dezembro",
        ];

        data.forEach((item) => {
          const date = new Date(item.date);
          const monthIndex = date.getMonth();
          const key = `${date.getFullYear()}-${monthIndex}`;

          if (!months[key]) {
            months[key] = {
              month: `${monthNames[monthIndex]} ${date.getFullYear()}`,
              monthIndex: monthIndex,
              year: date.getFullYear(),
              planted: 0,
              cut: 0,
            };
          }

          months[key].planted += item.planted;
          months[key].cut += item.cut;
        });

        return Object.values(months).sort((a, b) => {
          if (a.year !== b.year) return a.year - b.year;
          return a.monthIndex - b.monthIndex;
        });
      }

      // Função para agrupar dados por ano
      function groupDataByYear(data) {
        const years = {};

        data.forEach((item) => {
          const year = new Date(item.date).getFullYear();

          if (!years[year]) {
            years[year] = {
              year: year,
              planted: 0,
              cut: 0,
            };
          }

          years[year].planted += item.planted;
          years[year].cut += item.cut;
        });

        return Object.values(years).sort((a, b) => a.year - b.year);
      }

      // Função para formatar datas
      function formatDate(dateString) {
        const date = new Date(dateString);
        return `${date.getDate()}/${date.getMonth() + 1}`;
      }

      // Função para atualizar estatísticas
      function updateStats() {
        let plantedTotal = 0;
        let cutTotal = 0;
        let period = 1; // Fator de período em dias

        switch (currentPeriod) {
          case "day":
            // Dados do último dia
            if (forestData.length > 0) {
              const lastDay = forestData[forestData.length - 1];
              plantedTotal = lastDay.planted;
              cutTotal = lastDay.cut;
            }
            period = 1;
            break;

          case "week":
            // Dados da última semana (7 dias)
            const lastWeekData = forestData.slice(-7);
            plantedTotal = lastWeekData.reduce(
              (sum, item) => sum + item.planted,
              0
            );
            cutTotal = lastWeekData.reduce((sum, item) => sum + item.cut, 0);
            period = 7;
            break;

          case "month":
            // Dados do último mês (30 dias)
            const lastMonthData = forestData.slice(-30);
            plantedTotal = lastMonthData.reduce(
              (sum, item) => sum + item.planted,
              0
            );
            cutTotal = lastMonthData.reduce((sum, item) => sum + item.cut, 0);
            period = 30;
            break;

          case "year":
            // Dados do último ano (considerando todos os dados)
            plantedTotal = forestData.reduce(
              (sum, item) => sum + item.planted,
              0
            );
            cutTotal = forestData.reduce((sum, item) => sum + item.cut, 0);
            period = 365;
            break;
        }

        const balance = plantedTotal - cutTotal;

        // Calcular pegada de CO2
        const periodFactor = period / 365; // Fração do ano
        const co2Absorbed =
          (plantedTotal * CO2_PER_TREE_PER_YEAR * periodFactor) / 1000; // em toneladas
        const co2Released = (cutTotal * CO2_LOSS_PER_CUT_TREE) / 1000; // em toneladas
        const co2Impact = (co2Absorbed - co2Released).toFixed(2);

        document.getElementById("plantedValue").textContent = plantedTotal;
        document.getElementById("cutValue").textContent = cutTotal;
        document.getElementById("balanceValue").textContent = balance;
        document.getElementById("co2Value").textContent = co2Impact;

        // Atualizar o medidor de CO2
        updateCO2Meter(co2Impact);
      }

      // Função para atualizar o medidor de CO2
      function updateCO2Meter(co2Impact) {
        const meterFill = document.getElementById("co2MeterFill");
        const co2Status = document.getElementById("co2Status");

        // A escala vai de -10 a +10 toneladas
        const maxRange = 10;
        const percentage =
          ((parseFloat(co2Impact) + maxRange) / (maxRange * 2)) * 100;

        // Limitar entre 0 e 100%
        const clampedPercentage = Math.min(Math.max(percentage, 0), 100);
        meterFill.style.width = clampedPercentage + "%";

        // Definir cor com base no impacto
        if (co2Impact > 0) {
          meterFill.style.background =
            "linear-gradient(to right, #ffeb3b, #4caf50)";
          co2Status.textContent = `Positivo: Absorvendo ${Math.abs(
            co2Impact
          )} toneladas de CO₂`;
          co2Status.style.color = "#2e7d32";
        } else if (co2Impact < 0) {
          meterFill.style.background =
            "linear-gradient(to right, #f44336, #ffeb3b)";
          co2Status.textContent = `Negativo: Liberando ${Math.abs(
            co2Impact
          )} toneladas de CO₂`;
          co2Status.style.color = "#c62828";
        } else {
          meterFill.style.background = "#ffeb3b";
          co2Status.textContent = "Impacto neutro de carbono";
          co2Status.style.color = "#f57f17";
        }
      }

      document.getElementById("logoutBtn").addEventListener("click", () => {
        localStorage.removeItem("auth");
        localStorage.removeItem("username");
        toggleLoginUI(false);
      });

      function toggleLoginUI(isLoggedIn, username = "") {
        document.getElementById("data-entry").style.display = isLoggedIn
          ? "block"
          : "none";
        document.getElementById("loginFormContainer").style.display = isLoggedIn
          ? "none"
          : "block";
        document.getElementById("logoutSection").style.display = isLoggedIn
          ? "block"
          : "none";
        document.getElementById(
          "welcomeUser"
        ).textContent = `Bem-vindo, ${username}`;
      }

      let redefinirIdUsuario = null;

      document
        .getElementById("loginForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();
          const username = document.getElementById("username").value;
          const senha = document.getElementById("password").value;

          const response = await fetch("login.php", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username, senha }),
          });

          const result = await response.json();

          if (result.success) {
            if (result.primeiro_acesso == 1) {
              redefinirIdUsuario = result.usuario_id;
              document.getElementById("senhaResetContainer").style.display =
                "block";
            } else {
              localStorage.setItem("auth", "true");
              localStorage.setItem("username", username);
              toggleLoginUI(true, username);
            }
          } else {
            alert(result.error || "Erro no login");
          }
        });

      async function enviarNovaSenha() {
        const novaSenha = document.getElementById("novaSenha").value;
        if (!novaSenha) return alert("Digite a nova senha");

        const response = await fetch("redefinir_senha.php", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            usuario_id: redefinirIdUsuario,
            nova_senha: novaSenha,
          }),
        });

        const result = await response.json();
        if (result.success) {
          alert("Senha atualizada com sucesso!");
          document.getElementById("senhaResetContainer").style.display = "none";
        } else {
          alert(result.error || "Erro ao redefinir senha");
        }
      }

      carregarDados();
    </script>
  </body>
</html>
